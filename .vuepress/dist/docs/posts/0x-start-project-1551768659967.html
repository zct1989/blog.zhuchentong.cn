<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>0x-start-project源码学习 - 2 | 紫菜苔de前端小馆</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.87941fce.css" as="style"><link rel="preload" href="/assets/js/app.7e25505e.js" as="script"><link rel="preload" href="/assets/js/3.4c456c83.js" as="script"><link rel="preload" href="/assets/js/59.d9b4b32f.js" as="script"><link rel="prefetch" href="/assets/js/1.7f9baa1d.js"><link rel="prefetch" href="/assets/js/10.b3078e71.js"><link rel="prefetch" href="/assets/js/100.d8ae016d.js"><link rel="prefetch" href="/assets/js/101.f6577f56.js"><link rel="prefetch" href="/assets/js/102.24046e40.js"><link rel="prefetch" href="/assets/js/103.d5b9915f.js"><link rel="prefetch" href="/assets/js/104.6d9317fc.js"><link rel="prefetch" href="/assets/js/105.1c735d52.js"><link rel="prefetch" href="/assets/js/106.553f3416.js"><link rel="prefetch" href="/assets/js/107.2ff9089f.js"><link rel="prefetch" href="/assets/js/108.72334a91.js"><link rel="prefetch" href="/assets/js/109.ab5b89d9.js"><link rel="prefetch" href="/assets/js/11.48b38e03.js"><link rel="prefetch" href="/assets/js/110.c00c4692.js"><link rel="prefetch" href="/assets/js/111.054f232b.js"><link rel="prefetch" href="/assets/js/112.348fdc76.js"><link rel="prefetch" href="/assets/js/113.2666954c.js"><link rel="prefetch" href="/assets/js/114.8401f8aa.js"><link rel="prefetch" href="/assets/js/115.7a7040eb.js"><link rel="prefetch" href="/assets/js/116.4c68494b.js"><link rel="prefetch" href="/assets/js/117.628714f4.js"><link rel="prefetch" href="/assets/js/118.2a187c2e.js"><link rel="prefetch" href="/assets/js/119.35c2bc90.js"><link rel="prefetch" href="/assets/js/12.443612ee.js"><link rel="prefetch" href="/assets/js/120.d049d227.js"><link rel="prefetch" href="/assets/js/121.48041260.js"><link rel="prefetch" href="/assets/js/122.8be84181.js"><link rel="prefetch" href="/assets/js/123.bf0e653c.js"><link rel="prefetch" href="/assets/js/124.44ed450f.js"><link rel="prefetch" href="/assets/js/125.09870bea.js"><link rel="prefetch" href="/assets/js/126.42a4886a.js"><link rel="prefetch" href="/assets/js/127.af7ff8a1.js"><link rel="prefetch" href="/assets/js/128.7291d4f2.js"><link rel="prefetch" href="/assets/js/129.c49e42e3.js"><link rel="prefetch" href="/assets/js/13.dadac269.js"><link rel="prefetch" href="/assets/js/130.e1ee2b4b.js"><link rel="prefetch" href="/assets/js/131.27c50567.js"><link rel="prefetch" href="/assets/js/132.79c2b4e0.js"><link rel="prefetch" href="/assets/js/133.df0574a4.js"><link rel="prefetch" href="/assets/js/134.f38f6bca.js"><link rel="prefetch" href="/assets/js/14.e80ad288.js"><link rel="prefetch" href="/assets/js/15.0f63582e.js"><link rel="prefetch" href="/assets/js/16.0b17d178.js"><link rel="prefetch" href="/assets/js/17.e0125a2a.js"><link rel="prefetch" href="/assets/js/18.8a42eed8.js"><link rel="prefetch" href="/assets/js/19.15a10742.js"><link rel="prefetch" href="/assets/js/20.b7b1d0f5.js"><link rel="prefetch" href="/assets/js/21.40791261.js"><link rel="prefetch" href="/assets/js/22.f2c95780.js"><link rel="prefetch" href="/assets/js/23.ac518c9f.js"><link rel="prefetch" href="/assets/js/24.1dae90a3.js"><link rel="prefetch" href="/assets/js/25.efc09146.js"><link rel="prefetch" href="/assets/js/26.ab86d874.js"><link rel="prefetch" href="/assets/js/27.e5f565e9.js"><link rel="prefetch" href="/assets/js/28.0469e9c4.js"><link rel="prefetch" href="/assets/js/29.a8de8547.js"><link rel="prefetch" href="/assets/js/30.c0475b4a.js"><link rel="prefetch" href="/assets/js/31.b5eb0553.js"><link rel="prefetch" href="/assets/js/32.9c19ae0e.js"><link rel="prefetch" href="/assets/js/33.b1ed7508.js"><link rel="prefetch" href="/assets/js/34.1e16e05c.js"><link rel="prefetch" href="/assets/js/35.293091db.js"><link rel="prefetch" href="/assets/js/36.252b615a.js"><link rel="prefetch" href="/assets/js/37.1cd8996a.js"><link rel="prefetch" href="/assets/js/38.167a82a3.js"><link rel="prefetch" href="/assets/js/39.33db9824.js"><link rel="prefetch" href="/assets/js/4.54882aa9.js"><link rel="prefetch" href="/assets/js/40.450d32a0.js"><link rel="prefetch" href="/assets/js/41.9287a314.js"><link rel="prefetch" href="/assets/js/42.141e28e4.js"><link rel="prefetch" href="/assets/js/43.8a75dd80.js"><link rel="prefetch" href="/assets/js/44.3ee27bf5.js"><link rel="prefetch" href="/assets/js/45.4a481968.js"><link rel="prefetch" href="/assets/js/46.856423a7.js"><link rel="prefetch" href="/assets/js/47.f5eecad5.js"><link rel="prefetch" href="/assets/js/48.bf2e2c37.js"><link rel="prefetch" href="/assets/js/49.9de65ad2.js"><link rel="prefetch" href="/assets/js/5.394b0d79.js"><link rel="prefetch" href="/assets/js/50.5717ea36.js"><link rel="prefetch" href="/assets/js/51.559ab86e.js"><link rel="prefetch" href="/assets/js/52.fa636028.js"><link rel="prefetch" href="/assets/js/53.855c5365.js"><link rel="prefetch" href="/assets/js/54.479224a9.js"><link rel="prefetch" href="/assets/js/55.82303205.js"><link rel="prefetch" href="/assets/js/56.06703298.js"><link rel="prefetch" href="/assets/js/57.834a7c69.js"><link rel="prefetch" href="/assets/js/58.38a6ec3d.js"><link rel="prefetch" href="/assets/js/6.c3665a69.js"><link rel="prefetch" href="/assets/js/60.f93eef75.js"><link rel="prefetch" href="/assets/js/61.fc7d627b.js"><link rel="prefetch" href="/assets/js/62.37562b69.js"><link rel="prefetch" href="/assets/js/63.71270651.js"><link rel="prefetch" href="/assets/js/64.13e7ae2c.js"><link rel="prefetch" href="/assets/js/65.1251d365.js"><link rel="prefetch" href="/assets/js/66.31ee93bf.js"><link rel="prefetch" href="/assets/js/67.66ee58aa.js"><link rel="prefetch" href="/assets/js/68.c00ea48a.js"><link rel="prefetch" href="/assets/js/69.06818970.js"><link rel="prefetch" href="/assets/js/7.6efe852a.js"><link rel="prefetch" href="/assets/js/70.c3da057f.js"><link rel="prefetch" href="/assets/js/71.4a192e57.js"><link rel="prefetch" href="/assets/js/72.66c8fbc5.js"><link rel="prefetch" href="/assets/js/73.faf61deb.js"><link rel="prefetch" href="/assets/js/74.e3a9223e.js"><link rel="prefetch" href="/assets/js/75.b72d7462.js"><link rel="prefetch" href="/assets/js/76.2cdf4ef4.js"><link rel="prefetch" href="/assets/js/77.8cd6514e.js"><link rel="prefetch" href="/assets/js/78.7ca132ea.js"><link rel="prefetch" href="/assets/js/79.41e2ac49.js"><link rel="prefetch" href="/assets/js/8.53b5f5e2.js"><link rel="prefetch" href="/assets/js/80.13b4e376.js"><link rel="prefetch" href="/assets/js/81.dd6a6ef0.js"><link rel="prefetch" href="/assets/js/82.09201718.js"><link rel="prefetch" href="/assets/js/83.4605bf24.js"><link rel="prefetch" href="/assets/js/84.44fd975f.js"><link rel="prefetch" href="/assets/js/85.e5dc6b5f.js"><link rel="prefetch" href="/assets/js/86.0e2bc0cc.js"><link rel="prefetch" href="/assets/js/87.6373beea.js"><link rel="prefetch" href="/assets/js/88.43f718d2.js"><link rel="prefetch" href="/assets/js/89.59462d75.js"><link rel="prefetch" href="/assets/js/9.72eda18e.js"><link rel="prefetch" href="/assets/js/90.8136b873.js"><link rel="prefetch" href="/assets/js/91.3216e3ce.js"><link rel="prefetch" href="/assets/js/92.94ec4c29.js"><link rel="prefetch" href="/assets/js/93.712e48a3.js"><link rel="prefetch" href="/assets/js/94.a674e097.js"><link rel="prefetch" href="/assets/js/95.e365ad29.js"><link rel="prefetch" href="/assets/js/96.eb2961b1.js"><link rel="prefetch" href="/assets/js/97.cf9e240e.js"><link rel="prefetch" href="/assets/js/98.37ffbc3f.js"><link rel="prefetch" href="/assets/js/99.ad9f19e6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.87941fce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container flex-row"><div class="sider-container"><div class="slider flex-column justify-content-center align-items-center"><div class="avatar"><img src="/avatar.jpg"></div> <div class="title">
        紫菜苔de前端小馆
    </div></div></div> <div class="post-container flex-auto" data-v-5185f74d><div class="title-container" data-v-5185f74d><div class="title" data-v-5185f74d>0x-start-project源码学习 - 2</div> <div class="date" data-v-5185f74d>2019年03月06日 01:03</div></div> <div class="content-container" data-v-5185f74d><div class="content__default" data-v-5185f74d><p>之前介绍了<a href="https://github.com/0xProject/0x-starter-project" target="_blank" rel="noopener noreferrer">0x-start-project<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>学习前需要只要的一些知识，现在我们来具体的学习<code>0x-start-project</code>。
<code>0x-start-project</code>是对<code>0x-project</code>一些具体业务场景的模拟与实现，通过对<code>0x-start-project</code>源码的学习，可以更加便于我们了解<code>0x-project</code>的以业务流程以及具体代码的实现。</p> <p>通过查看<a href="https://github.com/0xProject/0x-starter-project/blob/master/src/scenarios/all.ts" target="_blank" rel="noopener noreferrer">scenarios/all<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文件，可以发现<code>0x-start-project</code>主要模拟实现了如下场景:</p> <ul><li>fillOrderERC20();</li> <li>fillOrderFees();</li> <li>fillOrderERC721();</li> <li>matchOrders();</li> <li>executeTransaction();</li> <li>executeTransactionCancelOrder();</li> <li>cancelOrdersUpTo();</li> <li>forwarder_buy_erc20_tokens();</li> <li>forwarder_buy_erc721_tokens();</li> <li>fillOrderMultiAsset();</li> <li>dutchAuction();</li></ul> <p>它们对应了0x project不同的业务场景或交易策略。</p> <p>在这些场景之外还提供了可以运行的<code>SRA(standard relayer api)</code>服务来模拟简单的<code>Relayer</code>的实现。</p> <p>在开始运行项目之前，你需要使用<code>0x project</code>提供的ganache快照，来运行<code>ganache-cli</code>：</p> <div class="language- extra-class"><pre class="language-text"><code>yarn download_snapshot
yarn ganache-cli
</code></pre></div><p>我们本次会主要学习下面三个场景:</p> <ul><li>fillOrderERC20();</li> <li>fillOrderFees();</li> <li>fillOrderERC721();</li></ul> <p>它们都是以填写订单的场景，区别在于交易的币种以及是否具有交易费用。</p> <p>基本都是如下步骤:</p> <ol><li>向0x进行对应交易币种授权,如含有交易费用需要对ZRX进行授权</li> <li>卖方创建订单并进行签名</li> <li>买方执行签名后订单并完成交易</li></ol> <p>订单在第3步之前都在链下进行，当执行订单时(<code>fillOrder</code>)数据才会上链，这时会返回对应的<code>txHash</code>,通过判断<code>txHash</code>来确认交易完成。</p> <p>我们以对应的<code>fillOrderFees</code>代码为例来学习:</p> <div class="language- extra-class"><pre class="language-text"><code>PrintUtils.printScenario('Fill Order with Fees');
    // Initialize the ContractWrappers, this provides helper functions around calling
    // 0x contracts as well as ERC20/ERC721 token contracts on the blockchain
    // 实例化contractWrappers
    const contractWrappers = new ContractWrappers(providerEngine, { networkId: NETWORK_CONFIGS.networkId });
    // Initialize the Web3Wrapper, this provides helper functions around fetching
    // account information, balances, general contract logs
    // 实例化web3Wrapper
    // providerEngine确定了进行连接的网络
    const web3Wrapper = new Web3Wrapper(providerEngine);
    // 从ganache生成的10个地址中取前三个分别作为卖方地址，买方地址，中介费用接收地址
    const [maker, taker, feeRecipient] = await web3Wrapper.getAvailableAddressesAsync();
    // 获取ZRX代币合约地址
    const zrxTokenAddress = contractAddresses.zrxToken;
    // 获取WETH代币合约地址
    const etherTokenAddress = contractAddresses.etherToken;
    // PrintUtils为辅助的信息打印库
    const printUtils = new PrintUtils(
        web3Wrapper,
        contractWrappers,
        { maker, taker, feeRecipient },
        { WETH: etherTokenAddress, ZRX: zrxTokenAddress },
    );
    // 输出账户信息
    printUtils.printAccounts();

    // the amount the maker is selling in maker asset
    // toBaseUnitAmount为按精度转换金额，返回值为BigNumber
    // 卖方出售金额
    const makerAssetAmount = Web3Wrapper.toBaseUnitAmount(new BigNumber(5), DECIMALS);
    // the amount the maker wants of taker asset
    // 卖方支付金额
    const takerAssetAmount = Web3Wrapper.toBaseUnitAmount(new BigNumber(0.1), DECIMALS);
    // the amount of fees the maker pays in ZRX
    // 卖方交易费用
    const makerFee = Web3Wrapper.toBaseUnitAmount(new BigNumber(0.01), DECIMALS);
    // the amount of fees the taker pays in ZRX
    // 买方交易费用
    const takerFee = Web3Wrapper.toBaseUnitAmount(new BigNumber(0.01), DECIMALS);

    // 0x v2 uses hex encoded asset data strings to encode all the information needed to identify an asset
    // 如果是ERC20,AssetData需要通过encodeERC20AssetData设置tokenaddress来确定币种
    // 如果是ERC721,AssetData可以传入tokenaddress以及tokenid
    // const makerAssetData = assetDataUtils.ecodeERC721AssetData(dummyERC721TokenContract.address, tokenId);
    // 卖方卖出币种
    const makerAssetData = assetDataUtils.encodeERC20AssetData(zrxTokenAddress);
    // 买方卖出币种
    const takerAssetData = assetDataUtils.encodeERC20AssetData(etherTokenAddress);
    
    // 用于接收fillorder交易的Hash
    let txHash;
    // 用于接收fillorder交易的数据
    let txReceipt;

    // Approve the ERC20 Proxy to move ZRX for maker and taker
    // 设置卖方交易授权
    // 用于支付交易费用
    const makerZRXApprovalTxHash = await contractWrappers.erc20Token.setUnlimitedProxyAllowanceAsync(
        zrxTokenAddress,
        maker,
    );
    await printUtils.awaitTransactionMinedSpinnerAsync('Maker ZRX Approval', makerZRXApprovalTxHash);
    // 设置买方交易授权
    // 用于支付交易费用
    // ERC721需要使用contractWrappers.erc721Token.setProxyApprovalForAllAsync进行授权
    const takerZRXApprovalTxHash = await contractWrappers.erc20Token.setUnlimitedProxyAllowanceAsync(
        zrxTokenAddress,
        taker,
    );
    await printUtils.awaitTransactionMinedSpinnerAsync('Taker ZRX Approval', takerZRXApprovalTxHash);

    // Allow the 0x ERC20 Proxy to move WETH on behalf of takerAccount
    // WETH账户授权
    const takerWETHApprovalTxHash = await contractWrappers.erc20Token.setUnlimitedProxyAllowanceAsync(
        etherTokenAddress,
        taker,
    );
    await printUtils.awaitTransactionMinedSpinnerAsync('Taker WETH Approval', takerWETHApprovalTxHash);

    // Convert ETH into WETH for taker by depositing ETH into the WETH contract
    // 兑换WETH
    const takerWETHDepositTxHash = await contractWrappers.etherToken.depositAsync(
        etherTokenAddress,
        takerAssetAmount,
        taker,
    );
    await printUtils.awaitTransactionMinedSpinnerAsync('Taker WETH Deposit', takerWETHDepositTxHash);
   // 打印操作信息
    PrintUtils.printData('Setup', [
        ['Maker ZRX Approval', makerZRXApprovalTxHash],
        ['Taker ZRX Approval', takerZRXApprovalTxHash],
        ['Taker WETH Approval', takerWETHApprovalTxHash],
        ['Taker WETH Deposit', takerWETHDepositTxHash],
    ]);

    // Set up the Order and fill it
    // 生成订单过期时间
    const randomExpiration = getRandomFutureDateInSeconds();
    // 0x合约地址(用于交易)
    const exchangeAddress = contractAddresses.exchange;

    // Create the order
    // 创建订单信息
    const order: Order = {
        exchangeAddress, // 0x合约地址
        makerAddress: maker, // maker卖方地址
        takerAddress: NULL_ADDRESS,// 买方地址
        senderAddress: NULL_ADDRESS,// TODO: 应该是执行交易者的地址
        feeRecipientAddress: feeRecipient,// 中介费用接收地址
        expirationTimeSeconds: randomExpiration, // 过期时间
        salt: generatePseudoRandomSalt(),//随机种子 - 盐
        makerAssetAmount,// 卖方交易金额
        takerAssetAmount,// 买方交易金额
        makerAssetData,// 卖方交易币种
        takerAssetData,// 买方交易币种
        makerFee,// 卖方支付中介费用 为0代表无中介费用
        takerFee,// 买方支付中介费用
    };
	
    // 打印订单信息
    printUtils.printOrder(order);

    // Print out the Balances and Allowances
    // 打印授权信息
    await printUtils.fetchAndPrintContractAllowancesAsync();
    // 打印账户余额信息
    await printUtils.fetchAndPrintContractBalancesAsync();

    // Generate the order hash and sign it
    // 获取订单HASH
    const orderHashHex = orderHashUtils.getOrderHashHex(order);
    // 进行订单签名
    const signature = await signatureUtils.ecSignHashAsync(providerEngine, orderHashHex, maker);
    // 签名后的订单,多出了signature字段
    const signedOrder = { ...order, signature };
    // Fill the Order via 0x Exchange contract
    // 执行订单交易
    txHash = await contractWrappers.exchange.fillOrderAsync(signedOrder, takerAssetAmount, taker, {
        gasLimit: TX_DEFAULTS.gas,
    });
    // 等待交易完成获取交易数据
    txReceipt = await printUtils.awaitTransactionMinedSpinnerAsync('fillOrder', txHash);
    // 打印交易信息
    printUtils.printTransaction('fillOrder', txReceipt, [
        ['orderHash', orderHashHex],
        ['takerAssetAmount', takerAssetAmount.toString()],
    ]);

    // Print the Balances
    // 打印余额信息
    await printUtils.fetchAndPrintContractBalancesAsync();

    // Stop the Provider Engine
    providerEngine.stop();
</code></pre></div><p><a href="https://github.com/0xProject/0x-monorepo/tree/development/packages/web3-wrapper" target="_blank" rel="noopener noreferrer">Web3Wrapper<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是的以太坊相关的工具库，用于相关的工具操作。</p> <p><a href="https://github.com/0xProject/0x-monorepo/tree/development/packages/contract-wrappers" target="_blank" rel="noopener noreferrer">ContractWrappers<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是合约相关的操作库，进行如<code>ERC20</code>,<code>ERC721</code>,<code>WETH</code>等合约相关的操作。</p> <p>其中<code>contractWrappers.exchange</code>是和<code>0x</code>相关交易的操作</p></div></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7e25505e.js" defer></script><script src="/assets/js/3.4c456c83.js" defer></script><script src="/assets/js/59.d9b4b32f.js" defer></script>
  </body>
</html>
