(window.webpackJsonp=window.webpackJsonp||[]).push([[90],{407:function(a,e,t){"use strict";t.r(e);var n=t(39),o=Object(n.a)({},(function(){var a=this,e=a.$createElement,t=a._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("p",[a._v("很多项目中都有下载一些图片文件的需求，常用的方式是通过a标签实现:")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('<a href="download.jpg"></a>\n')])])]),t("p",[a._v("但是你会在使用时发现点击该链接后并不是下载对应的图片，而是在浏览器中打开了对应的图片，这并不是我们想要的。")]),a._v(" "),t("p",[a._v("应为浏览器判断是否下载一般会根据文件返回的头信息进行判断，如果给返回了对应的头信息则会进行下载：")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("header('Content-type: image/jpeg'); \nheader(\"Content-Disposition: attachment; filename='download.jpg'\"); \n")])])]),t("p",[a._v("很好，但是如果这样还需要后端人员的配合，我们有没有其他的方式呢？有，那就是使用"),t("code",[a._v("download")]),a._v("属性:")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('<a href="download.jpg" download>下载</a>\n')])])]),a._v(" "),t("p",[a._v("这样就可以直接调用浏览器的下载功能，而且还可以通过传参给"),t("code",[a._v("download")]),a._v("来实现文件的重命名功能：")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('<a href="download.jpg" download="othername.jpg">下载</a>\n')])])]),t("p",[t("code",[a._v("download")]),a._v("属性的兼容性如下:")]),a._v(" "),t("p",[t("a",{attrs:{href:"https://caniuse.com/download/embed",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://caniuse.com/download/embed"),t("OutboundLink")],1)]),a._v(" "),t("p",[a._v("但是这个方案依然有他的问题:")]),a._v(" "),t("blockquote",[t("p",[a._v("chrome 69.0.3497.92 中已经严格遵循同源策略的限制，如果加载了非同源的内容，download 属性将失效，等效导航功能。")])]),a._v(" "),t("p",[a._v("现在很多项目已经是前后端分离，经常遇到跨域的问题，但是在跨域的情况下"),t("code",[a._v("download")]),a._v("属性完全没有作用，那么应该如何解决。")]),a._v(" "),t("p",[a._v("基本的思路就是让跨域变成不是跨域。")]),a._v(" "),t("hr"),a._v(" "),t("p",[a._v("一种思路就是通过反向代理进行处理，来解决跨域问题：")]),a._v(" "),t("p",[a._v("1.将原先访问图片云服务的资源改为访问网站图片资源，例如：")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('  <a href="http://prod.upaiyun.com/images/xxx.jpg" download="xxx.jpg">download</a>\n  改为:\n  <a href="http://www.mysite.com/images/xxx.jpg" download="xxx.jpg">download</a>\n')])])]),t("p",[a._v("2.配置nginx反向代理")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v("  location /images {\n    proxy_redirect    off;\n    proxy_pass https://prod.upaiyun.com;\n  }\n")])])]),t("hr"),a._v(" "),t("p",[a._v("另一种方式就是，创建一个非跨域的数据源：")]),a._v(" "),t("p",[a._v("1.下载原数据文件，这里可以使用img标签或者通过ajax，fetch进行下载")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('   function download(url, name) {\n        name = name || url\n        // fetch抓取图片数据\n        fetch(url).then(response=> {\n            if( response.status == 200 )\n                // 返回的.blob()为promise，然后生成了blob对象，此方法获得的blob对象包含了数据类型，十分方便\n                return response.blob()\n            throw new Error(`status: ${response.status}.`)\n        }).then(blob=> {\n            // 获取到blob对象\n            downloadFile(name, blob)\n        }).catch(error=> {\n            console.log("failed. cause:", error)\n        })\n    }\n')])])]),t("p",[a._v("2.通过"),t("code",[a._v("URL.createObjectURL")]),a._v("给a标签设置数据源")]),a._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[a._v('function downloadFile(fileName, blob) {\n       const anchor = document.getElementById("a")\n       // 创建指向blob对象地址\n       const src = URL.createObjectURL(blob)\n       anchor.download = fileName\n       anchor.href = src\n}\n')])])]),t("p",[a._v("这样就可以实现在跨域情况下的图片资源下载。")]),a._v(" "),t("p",[a._v("当然还有一下其他类似的方案如使用"),t("code",[a._v("FileReader")]),a._v("的"),t("code",[a._v("readAsDataURL")]),a._v("来生成数据,或使用"),t("code",[a._v("Canvas")]),a._v("的"),t("code",[a._v("toDataUrl")]),a._v("都可以达到一样的效果。")])])}),[],!1,null,null,null);e.default=o.exports}}]);